<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBl_UJ_MQziKKhB-GB2MIVrXrhUwlX6IyY&libraries=directions,geometry,places&callback=initMap"
    async defer></script>
<style type="text/css">
    #map {
        width: 500pt;
        height: 350pt;
        margin-top: 10px;
        margin-left: 25%;
    }
</style>

<body>
    <input id="pac-input" class="controls" type="text" placeholder="Search Box">
    <div id="map"></div>


    <script>
        var map;
        var service;
        var infowindow;


        var getDistance = function (lat1, lon1, lat2, lon2) {
            var deg2rad = 0.017453292519943295; // === Math.PI / 180
            var cos = Math.cos;
            lat1 *= deg2rad;
            lon1 *= deg2rad;
            lat2 *= deg2rad;
            lon2 *= deg2rad;
            var diam = 12742; // Diameter of the earth in km (2 * 6371)
            var dLat = lat2 - lat1;
            var dLon = lon2 - lon1;
            var a = ((1 - cos(dLat)) +
                (1 - cos(dLon)) * cos(lat1) * cos(lat2)
            ) / 2;

            return diam * Math.asin(Math.sqrt(a)) * 1000;
        };

        function initMap() {

            let getLocation = function () {
                let coordinates = { lat: 0, lng: 0 };
                if (navigator.geolocation) {
                    return navigator.geolocation.getCurrentPosition(showPosition);
                } else {
                    return;
                }
            }
            window.onload = getLocation

            function showPosition(position) {

                coordinates = { lat: position.coords.latitude, lng: position.coords.longitude }
                console.log(coordinates)
                var currentLocation = new google.maps.LatLng(coordinates.lat, coordinates.lng);

                infowindow = new google.maps.InfoWindow();
                map = new google.maps.Map(
                    document.getElementById('map'),
                    { center: new google.maps.LatLng({ lat: -29.9959280, lng: -51.109997 }), zoom: 15 });


                var bounds = map.getBounds();
                google.maps.event.addListenerOnce(map, 'idle', function () {
                    var makeBounds = new google.maps.LatLngBounds(
                        new google.maps.LatLng(-30.035751, -51.222606),
                        new google.maps.LatLng(-30.0470423, -51.2019747, 17)
                    );

                    map.fitBounds(makeBounds)

                    var request = {
                        bounds: map.getBounds(),
                        keyword: ['pontos turísticos']
                    };
                    service = new google.maps.places.PlacesService(map);
                    service.nearbySearch(request, function (results, status) {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            for (var i = 0; i < results.length; i++) {
                                createMarker(results[i], position);
                            }
                            map.setZoom(14);
                            map.setCenter(results[parseInt(results.length/2)].geometry.location);
                        }
                    });
                });
            }

            function createMarker(place, mainPosition) {
                var marker = new google.maps.Marker({
                    map: map,
                    position: place.geometry.location
                });

                google.maps.event.addListener(marker, 'click', function (mainPosition) {
                    infowindow.setContent(place.name);
                    infowindow.open(map, this);
                    setRoutes(mainPosition, place)


                });
            }

            function setRoutes(mainPosition, place) {
                var directionsRenderer = new google.maps.DirectionsRenderer;
                var directionsService = new google.maps.DirectionsService;

                directionsRenderer.setMap(map);

                makeRoutes(directionsService, directionsRenderer, mainPosition, place);
               
            }

            function makeRoutes(directionsService, directionsRenderer, mainPosition, place) {33
                directionsService.route({
                    origin: { lat: mainPosition.latLng.lat(), lng: mainPosition.latLng.lat() },  // Haight.
                    destination: { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() },  // Ocean Beach.
                    travelMode: google.maps.TravelMode["DRIVING"]
                }, function (response, status) {
                    if (status == 'OK') {
                        console.log("PONTOS INTERMEDIÀRIOS ===> " + response.routes[0].overview_path)
                        directionsRenderer.setDirections(response);
                    } else {
                        debugger
                        window.alert('Directions request failed due to ' + status);
                    }
                });
            }

        }
    </script>
</body>

</html>